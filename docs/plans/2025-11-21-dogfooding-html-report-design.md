# Dogfooding HTML Report Visual Tests - Design

**Date:** 2025-11-21
**Status:** Approved

## Overview

Create visual tests that use visual-uat to test its own HTML report structure. This serves as both dogfooding (using the tool on itself) and as a practical guard against unintended visual regressions when changing the HTML reporter.

## Problem Statement

When developers modify the HTML reporter structure (layout changes, new components, styling updates), there's currently no automated way to:
1. Verify the changes render correctly
2. Detect unintended visual regressions
3. Provide an example of visual-uat testing HTML content

## Design Decision

Use visual-uat to test visual-uat's own generated HTML reports through a two-stage process.

### Stage 1: Generate Fixture Report
Run visual-uat on the demo-app to create an HTML report that serves as the test target.

### Stage 2: Test the Report Structure
Use root-level visual-uat configuration to test the generated HTML report's visual structure.

## Architecture

### Workflow

```
┌─────────────────────────────────────┐
│  npm run setup:dogfood              │
│  (in examples/demo-app)             │
│                                     │
│  Runs: visual-uat run               │
│  Generates: .visual-uat/reports/    │
│             latest.html             │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  npm run test:dogfood               │
│  (in root)                          │
│                                     │
│  Serves: demo-app reports dir       │
│  Tests: HTML report structure       │
│  Compares: baseline vs current      │
└─────────────────────────────────────┘
```

### File Structure

```
visual-uat/
├── package.json (new scripts)
├── visual-uat.config.js (updated targetRunner)
├── tests/
│   ├── specs/
│   │   └── html-report-structure.md (new spec)
│   └── generated/ (generated test goes here)
└── examples/
    └── demo-app/
        └── .visual-uat/
            └── reports/
                └── latest.html (generated by setup:dogfood)
```

## Implementation Details

### NPM Scripts

**package.json additions:**
```json
{
  "scripts": {
    "setup:dogfood": "cd examples/demo-app && npx visual-uat run",
    "test:dogfood": "npx visual-uat run"
  }
}
```

### Configuration Changes

**visual-uat.config.js (root):**
```javascript
targetRunner: {
  startCommand: 'npx serve -l $PORT examples/demo-app/.visual-uat/reports'
}
```

This serves the generated reports directory using `npx serve`, making `latest.html` accessible for testing.

### Test Spec

**tests/specs/html-report-structure.md:**
```markdown
# HTML Report Structure

Test the visual structure and layout of the generated HTML report.

## Test Steps
1. Navigate to the report page
2. Verify the overall page renders correctly
3. Capture full-page screenshot

## Expected Behavior
- Report displays with header, status summary, and test results
- All sections are visible and properly styled
- No layout breaks or rendering issues
```

## Use Cases

### Use Case 1: Detecting Unintended Changes
**Scenario:** Developer refactors CSS class names in HTML reporter
**Outcome:** Visual diff shows if layout broke, even though functionality works

### Use Case 2: Validating Intentional Changes
**Scenario:** Developer adds new "filter by status" buttons to report
**Outcome:** Visual diff shows the new buttons, developer reviews and approves baseline

### Use Case 3: Example for Users
**Scenario:** User wants to see how to test static HTML content
**Outcome:** This dogfooding setup demonstrates serving HTML with `npx serve`

## Developer Workflow

```bash
# 1. Make changes to HTML reporter
vim src/plugins/html-reporter.ts

# 2. Generate fresh report to test
npm run setup:dogfood

# 3. Run visual tests against the report
npm run test:dogfood

# 4. Review visual diffs in generated report
open .visual-uat/reports/latest.html
```

## Constraints & Limitations

1. **Fixture dependency:** `setup:dogfood` must run successfully before `test:dogfood`
2. **Demo-app coupling:** Relies on demo-app having valid tests and configuration
3. **Single test initially:** Starting with one simple happy-path test (can expand later)
4. **Manual two-step:** Developer must remember to run setup before test (could be automated later)

## Future Enhancements

Possible future improvements (not in initial scope):
- Test specific report sections (empty states, error states, filter interactions)
- Combine setup and test into single command with staleness checks
- Test multiple report variations (all pass, all fail, mixed results)
- Add interactive feature testing (image comparison mode toggles)

## Success Criteria

1. `npm run setup:dogfood` successfully generates HTML report
2. `npm run test:dogfood` captures baseline and compares screenshots
3. Changes to HTML reporter structure trigger visual diffs
4. Setup serves as clear example of testing HTML content with visual-uat
